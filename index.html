<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petualangan Angka Cilik!</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden; /* Prevent scroll on initial load */
        }
        /* Custom styles for backface-hidden for flip animation */
        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden; /* Safari */
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            border-radius: 1rem;
        }
        .flashcard-back {
            transform: rotateY(180deg);
            background-color: #A78BFA; /* purple-400 for back of question card */
        }
        .flashcard-container.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }
        /* Gradient backgrounds - Adjusting to cool tones */
        .bg-gradient-blue-1 {
            background: linear-gradient(to bottom, #A7F3D0, #67E8F9); /* soft green-blue */
        }
        .bg-gradient-blue-2 {
            background: linear-gradient(to bottom, #BFDBFE, #93C5FD); /* light blue */
        }
        .bg-gradient-blue-3 {
            background: linear-gradient(to bottom, #C7D2FE, #A5B4FC); /* soft indigo */
        }
        .bg-gradient-blue-4 {
            background: linear-gradient(to bottom, #D8B4FE, #C4B5FD); /* soft purple */
        }
        .bg-gradient-blue-5 {
            background: linear-gradient(to bottom, #A7F3D0, #A7F3D0); /* solid soft green-blue */
        }
        /* Home screen background */
        .bg-home-gradient {
            background: linear-gradient(to bottom, #93C5FD, #C4B5FD); /* blue-300 to purple-400 */
        }

        /* Custom button hover effects */
        .btn-green:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-red:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-blue-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 10px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Score animation */
        @keyframes scorePop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .score-pop {
            animation: scorePop 0.3s ease-out;
        }

        /* Feedback message animation */
        @keyframes fadeInScale {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }
        .feedback-show {
            animation: fadeInScale 0.3s ease-out;
        }

        /* New Star Animation for correct answers (fly out horizontally) */
        @keyframes starFlyOut {
            0% { opacity: 1; transform: translate(0, 0) scale(0.5); }
            50% { opacity: 1; transform: translate(var(--star-dx), var(--star-dy)) scale(1.2); }
            100% { opacity: 0; transform: translate(var(--star-dx-end), var(--star-dy-end)) scale(0.8); }
        }
        .animated-star-correct {
            position: absolute;
            font-size: 2rem;
            color: #FCD34D; /* yellow-400 */
            animation: starFlyOut 0.8s forwards ease-out;
            pointer-events: none;
            z-index: 10;
        }

        /* New Star Animation for incorrect answers (fly away from score) */
        @keyframes starFlyAway {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            100% { opacity: 0; transform: translate(50px, -50px) scale(0.5); } /* Fly up-right and fade */
        }
        .animated-star-incorrect {
            position: absolute;
            font-size: 2rem;
            color: #EF4444; /* red-500 */
            animation: starFlyAway 0.8s forwards ease-out;
            pointer-events: none;
            z-index: 10;
        }

        /* Modal specific styles */
        .modal-show {
            transform: scale(1) !important;
            opacity: 1 !important;
        }

        /* Updated: 3D Gradient for Flashcard (Darker Blues) */
        #flashcard-container {
            background: linear-gradient(145deg, #3B82F6, #2563EB); /* Darker blue gradient */
            box-shadow: 
                0 15px 30px rgba(0, 0, 0, 0.4), /* Main shadow for depth */
                0 5px 10px rgba(0, 0, 0, 0.3) inset, /* Inner shadow for top-left light */
                -5px -5px 10px rgba(255, 255, 255, 0.15) inset; /* Inner shadow for bottom-right highlight */
            border: 2px solid rgba(255, 255, 255, 0.4); /* Subtle border for definition */
        }

        /* Updated: 3D Gradient for Option Buttons (Darker Cyan/Teal) */
        .btn-blue-option {
            background: linear-gradient(145deg, #0D9488, #0F766E); /* Darker teal gradient */
            box-shadow: 
                0 8px 15px rgba(0, 0, 0, 0.3), /* Main shadow */
                0 3px 6px rgba(0, 0, 0, 0.2) inset, /* Inner shadow for top-left light */
                -3px -3px 6px rgba(255, 255, 255, 0.1) inset; /* Inner shadow for bottom-right highlight */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Subtle border */
        }
        .btn-blue-option:hover {
            background: linear-gradient(145deg, #0F766E, #047857); /* Even darker teal on hover */
        }

        /* New: Animation for stars in the empty card */
        @keyframes popInFadeOut {
            0% { opacity: 0; transform: scale(0.5); }
            20% { opacity: 1; transform: scale(1.2); }
            80% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.8); }
        }

        /* Styles for multiple stars in pause animation */
        .pause-star-icon {
            font-size: 2.5rem; /* Smaller stars for multiple display */
            display: inline-block; /* Allow stars to sit next to each other */
            margin: 0 0.2rem; /* Small spacing between stars */
            animation: popInFadeOut 2s forwards ease-out; /* Apply animation to each star */
            opacity: 0; /* Start hidden */
        }
        .pause-star-icon.positive {
            color: #FCD34D; /* Yellow for positive */
        }
        .pause-star-icon.negative {
            color: #EF4444; /* Red for negative */
        }

        .star-change-text-small {
            font-size: 2rem; /* Smaller text */
            font-weight: bold;
            color: white;
            opacity: 0;
            animation: popInFadeOut 2s forwards ease-out;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-top: 0.5rem; /* Space below stars */
        }
        .star-change-text-small.positive {
            color: #84CC16; /* Green for positive */
        }
        .star-change-text-small.negative {
            color: #EF4444; /* Red for negative */
        }

        #pause-animation-container {
            display: flex; /* Use flexbox */
            flex-direction: column; /* Stack items vertically */
            align-items: center; /* Center horizontally */
            justify-content: center; /* Center vertically */
            position: absolute;
            inset: 0;
        }
        .star-icons-wrapper {
            display: flex; /* To arrange stars horizontally */
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Main App Container -->
    <div id="app" class="flex-1 flex flex-col">
        <!-- Home Screen -->
        <div id="home-screen" class="flex-1 flex flex-col items-center justify-center p-4 bg-home-gradient">
            <h1 class="text-5xl md:text-6xl font-extrabold text-white mb-10 text-center leading-tight drop-shadow-lg">
                Petualangan Angka Cilik!
            </h1>

            <button id="addition-btn" class="w-10/12 md:w-2/3 lg:w-1/2 p-6 mb-6 bg-green-500 rounded-2xl shadow-xl flex flex-col items-center justify-center transition-all duration-300 btn-green transform hover:scale-105">
                <i class="fas fa-plus-circle text-white text-5xl mb-2"></i>
                <span class="text-3xl font-bold text-white mt-2">Tambah-Tambahan</span>
            </button>

            <button id="subtraction-btn" class="w-10/12 md:w-2/3 lg:w-1/2 p-6 bg-red-500 rounded-2xl shadow-xl flex flex-col items-center justify-center transition-all duration-300 btn-red transform hover:scale-105">
                <i class="fas fa-minus-circle text-white text-5xl mb-2"></i>
                <span class="text-3xl font-bold text-white mt-2">Pengurangan</span>
            </button>
        </div>

        <!-- Flashcard Screen -->
        <div id="flashcard-screen" class="hidden flex-1 flex flex-col bg-gradient-blue-1 transition-colors duration-500">
            <!-- Header -->
            <div class="flex flex-row items-center justify-between p-4 bg-blue-600 bg-opacity-80 rounded-b-xl shadow-md">
                <div class="flex items-center bg-blue-500 px-4 py-2 rounded-xl shadow-inner">
                    <span id="timer-display" class="text-2xl font-bold text-white">0.0s</span>
                </div>
                <div class="flex items-center bg-blue-500 px-4 py-2 rounded-xl shadow-inner">
                    <i class="fas fa-star text-yellow-300 text-2xl mr-1"></i>
                    <span id="score" class="text-2xl font-bold text-white">0</span>
                    <span class="text-2xl font-bold text-white ml-1 mr-1">/</span>
                    <span id="target-score-display" class="text-2xl font-bold text-white">50</span>
                </div>
            </div>

            <!-- Content Area -->
            <div class="flex-1 flex flex-col items-center justify-center p-4 overflow-y-auto relative">
                <!-- Flashcard Container (Question Card) -->
                <div id="flashcard-container" class="w-11/12 max-w-md h-64 rounded-2xl shadow-lg relative cursor-pointer mb-6 transform hover:scale-105 transition-transform duration-300">
                    <div class="flashcard-inner">
                        <div class="flashcard-front">
                            <span id="question-expression" class="text-7xl font-bold text-white"></span>
                            <!-- New: Container for stars during pause -->
                            <div id="pause-animation-container" class="hidden">
                                <!-- Stars and text will be injected here by JavaScript -->
                            </div>
                        </div>
                        <div class="flashcard-back">
                            <span id="answer" class="text-7xl font-bold text-green-300"></span>
                            <span class="text-4xl font-bold text-white mt-4">Jawaban!</span>
                        </div>
                    </div>
                </div>

                <!-- Answer Options -->
                <div id="options-container" class="grid grid-cols-2 gap-4 mt-4 w-11/12 max-w-md">
                    <!-- Options will be injected here by JavaScript -->
                </div>

                <!-- Feedback Message -->
                <p id="feedback-message" class="text-3xl font-bold mt-6 text-center feedback-show text-white"></p>
                <!-- Narration Text -->
                <p id="narration-text" class="text-xl text-center text-white mt-2"></p>

                <!-- Star animation container -->
                <div id="star-animation-container" class="absolute inset-0 pointer-events-none"></div>
            </div>
        </div>
    </div>

    <!-- Level Complete Modal -->
    <div id="level-complete-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-sm w-full transform scale-90 opacity-0 transition-all duration-300" id="modal-content">
            <h2 class="text-4xl font-extrabold text-green-600 mb-4">🎉 Selamat! 🎉</h2>
            <p class="text-2xl text-gray-800 mb-6" id="modal-message"></p>
            <p class="text-xl text-gray-600 mb-8" id="modal-next-target"></p>

            <button id="next-level-btn" class="w-full p-4 mb-4 bg-blue-500 text-white font-bold rounded-xl text-2xl shadow-lg transition-all duration-300 hover:bg-blue-600 transform hover:scale-105">
                Lanjut ke Level Berikutnya
            </button>
            <button id="play-again-btn" class="w-full p-4 mb-4 bg-gray-400 text-white font-bold rounded-xl text-2xl font-bold shadow-lg transition-all duration-300 hover:bg-gray-500 transform hover:scale-105">
                Main Lagi
            </button>
            <button id="rest-btn" class="w-full p-4 bg-red-500 text-white font-bold rounded-xl text-2xl shadow-lg transition-all duration-300 hover:bg-red-600 transform hover:scale-105">
                Saya akan istirahat dulu
            </button>
        </div>
    </div>

    <script>
        // Firebase Placeholder (same as React Native version)
        // import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // let app, db, auth;
        // let userId = 'anonymous'; // Default user ID

        // const initializeFirebase = async () => {
        //   try {
        //     const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        //     const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        //     app = initializeApp(firebaseConfig);
        //     db = getFirestore(app);
        //     auth = getAuth(app);

        //     if (typeof __initial_auth_token !== 'undefined') {
        //       await signInWithCustomToken(auth, __initial_auth_token);
        //     } else {
        //       await signInAnonymously(auth);
        //     }

        //     onAuthStateChanged(auth, (user) => {
        //       if (user) {
        //         userId = user.uid;
        //         console.log('User is signed in:', userId);
        //       } else {
        //         userId = crypto.randomUUID();
        //         console.log('User is signed out or anonymous:', userId);
        //       }
        //     });
        //   } catch (error) {
        //     console.error("Error initializing Firebase:", error);
        //   }
        // };

        // DOM Elements
        const homeScreen = document.getElementById('home-screen');
        const flashcardScreen = document.getElementById('flashcard-screen');
        const additionBtn = document.getElementById('addition-btn');
        const subtractionBtn = document.getElementById('subtraction-btn');
        const scoreDisplay = document.getElementById('score');
        const targetScoreDisplay = document.getElementById('target-score-display');
        const flashcardContainer = document.getElementById('flashcard-container');
        const questionExpressionSpan = document.getElementById('question-expression');
        const answerSpan = document.getElementById('answer');
        const feedbackMessage = document.getElementById('feedback-message');
        const timerDisplay = document.getElementById('timer-display');
        const starAnimationContainer = document.getElementById('star-animation-container');
        const optionsContainer = document.getElementById('options-container');
        const narrationTextElement = document.getElementById('narration-text');

        // Modal Elements
        const levelCompleteModal = document.getElementById('level-complete-modal');
        const modalContent = document.getElementById('modal-content');
        const modalMessage = document.getElementById('modal-message');
        const modalNextTarget = document.getElementById('modal-next-target');
        const nextLevelBtn = document.getElementById('next-level-btn');
        const playAgainBtn = document.getElementById('play-again-btn');
        const restBtn = document.getElementById('rest-btn');

        // New elements for pause animation
        const pauseAnimationContainer = document.getElementById('pause-animation-container');


        // App State
        let currentOperation = null; // 'addition' or 'subtraction' (only for level 1)
        let currentQuestion = null;
        let score = 0;
        let level = 1; // Track current level
        let targetScore = 50; // Initial target for level 1
        let startTime; // To record when the question starts
        let timerInterval; // To update the timer display
        let questionTimeout; // New variable for the 15-second timeout

        // Global variable to track readiness for next question (for dynamic delay)
        let nextQuestionReadyCount = 0;

        // Array of background gradient classes for dynamic changes (cool tones)
        const backgroundGradients = [
            'bg-gradient-blue-1', /* soft green-blue */
            'bg-gradient-blue-2', /* light blue */
            'bg-gradient-blue-3', /* soft indigo */
            'bg-gradient-blue-4', /* soft purple */
            'bg-gradient-blue-5'  /* solid soft green-blue */
        ];

        // Array of motivational narrations for new questions
        const motivationalNarrations = [
            'Ayo, jawab dengan cepat!',
            'Semangat! Tunjukkan kemampuanmu!',
            'Kamu pasti bisa! Ayo fokus!',
            'Siap-siap, soal berikutnya datang!',
            'Ayo berlatih, jadi makin pintar!',
            'Kerja bagus! Ayo lanjutkan!',
            'Ini mudah bagimu! Ayo jawab!',
            'Tantangan baru menantimu!',
            'Cepat dan tepat! Ayo!'
        ];

        // Function to show a screen
        const showScreen = (screenId) => {
            homeScreen.classList.add('hidden');
            flashcardScreen.classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');
        };

        // Function to update the timer display
        const updateTimer = () => {
            const elapsedTime = (Date.now() - startTime) / 1000;
            timerDisplay.textContent = `${elapsedTime.toFixed(1)}s`;
        };

        // New function to check if both visual animations and narration are done
        const checkNextQuestionReadiness = () => {
            if (nextQuestionReadyCount >= 2) { // Both visual and narration are done
                generateQuestion();
                Array.from(optionsContainer.children).forEach(btn => btn.disabled = false);
            }
        };

        // Function to handle question timeout
        const handleTimeout = () => {
            clearInterval(timerInterval); // Stop the timer display
            Array.from(optionsContainer.children).forEach(btn => btn.disabled = true); // Disable options

            let starsChange = -2;
            score = Math.max(0, score + starsChange); // Deduct 2 stars, ensure score doesn't go below 0

            scoreDisplay.textContent = score;
            scoreDisplay.classList.add('score-pop');

            feedbackMessage.textContent = 'Waktu habis!';
            feedbackMessage.classList.remove('text-green-300');
            feedbackMessage.classList.add('text-red-300', 'feedback-show');

            const narrationMsg = 'Waktu habis! Bintangmu berkurang 2.';
            narrationTextElement.textContent = narrationMsg;
            
            // Clear question content during feedback phase
            questionExpressionSpan.textContent = '';
            answerSpan.textContent = '';
            flashcardContainer.classList.remove('flipped'); // Ensure card is front-facing if it was flipped

            // Show stars and text in the empty card
            showPauseAnimation(starsChange);

            // Reset count for next question readiness check
            nextQuestionReadyCount = 0; 

            // Part 1: Visual animations delay (now includes pause animation duration)
            setTimeout(() => {
                nextQuestionReadyCount++;
                checkNextQuestionReadiness();
            }, 2000); // Increased delay for popInFadeOut animation (2 seconds)

            // Part 2: Narration completion
            speakNarration(narrationMsg, () => {
                nextQuestionReadyCount++;
                checkNextQuestionReadiness();
            });

            spawnStars(1, 'incorrect'); // Animate star disappearing from score
        };

        // Function to generate a new question
        const generateQuestion = () => {
            // Clear previous timers and reset display
            clearInterval(timerInterval);
            clearTimeout(questionTimeout); // Clear the previous timeout
            timerDisplay.textContent = '0.0s';

            // Hide pause animation container
            pauseAnimationContainer.classList.add('hidden');
            pauseAnimationContainer.innerHTML = ''; // Clear any previous stars/text

            let num1, num2, num3, answer;
            let operatorSymbol;
            let maxAnswerRange; // Max possible answer for option generation

            // Logic based on current level
            if (level === 1) {
                num1 = Math.floor(Math.random() * 10) + 1; // 1-10
                num2 = Math.floor(Math.random() * 10) + 1; // 1-10
                operatorSymbol = currentOperation === 'addition' ? '+' : '-'; // Use initial choice for level 1

                if (operatorSymbol === '-') {
                    if (num2 > num1) {
                        [num1, num2] = [num2, num1];
                    }
                    answer = num1 - num2;
                } else {
                    answer = num1 + num2;
                }
                questionExpressionSpan.textContent = `${num1} ${operatorSymbol} ${num2}`;
                maxAnswerRange = 20; // Max for 10+10
            } else if (level === 2) {
                // Level 2: 3-number Addition
                num1 = Math.floor(Math.random() * 10) + 1; // 1-10
                num2 = Math.floor(Math.random() * 10) + 1; // 1-10
                num3 = Math.floor(Math.random() * 10) + 1; // 1-10
                operatorSymbol = '+'; // Always addition for level 2
                answer = num1 + num2 + num3;
                questionExpressionSpan.textContent = `${num1} + ${num2} + ${num3}`;
                maxAnswerRange = 30; // Max for 10+10+10
            } else { // level >= 3
                // Level 3 and beyond: Mixed 2-number Addition/Subtraction
                const operationType = Math.random() < 0.5 ? 'addition' : 'subtraction';
                num1 = Math.floor(Math.random() * 10) + 1; // 1-10
                num2 = Math.floor(Math.random() * 10) + 1; // 1-10

                if (operationType === 'subtraction') {
                    if (num2 > num1) {
                        [num1, num2] = [num2, num1];
                    }
                    operatorSymbol = '-';
                    answer = num1 - num2;
                } else {
                    operatorSymbol = '+';
                    answer = num1 + num2;
                }
                questionExpressionSpan.textContent = `${num1} ${operatorSymbol} ${num2}`;
                maxAnswerRange = 20; // Max for 10+10
            }

            currentQuestion = { num1, num2, num3: num3 || 0, operator: operatorSymbol, answer: answer }; // Include num3 for level 2
            answerSpan.textContent = currentQuestion.answer;

            // Reset flashcard flip state
            flashcardContainer.classList.remove('flipped');

            // Generate options based on maxAnswerRange
            const correctOption = currentQuestion.answer;
            const newOptions = new Set();
            newOptions.add(correctOption);
            while (newOptions.size < 4) {
                let fakeOption = Math.floor(Math.random() * (maxAnswerRange + 1)); // 0 to maxAnswerRange
                if (fakeOption !== correctOption && fakeOption >= 0) { // Ensure non-negative
                    newOptions.add(fakeOption);
                }
            }
            const shuffledOptions = Array.from(newOptions).sort(() => Math.random() - 0.5);
            renderOptions(shuffledOptions);

            // Start the timer for the new question
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 100);
            // Set the 15-second timeout
            questionTimeout = setTimeout(handleTimeout, 15000); // 15 seconds

            // Clear feedback and narration
            feedbackMessage.textContent = '';
            feedbackMessage.className = 'text-3xl font-bold mt-6 text-center text-white'; // Reset feedback style and ensure white text
            
            // Randomly select initial narration and speak it immediately
            const initialNarration = motivationalNarrations[Math.floor(Math.random() * motivationalNarrations.length)];
            narrationTextElement.textContent = initialNarration;
            speakNarration(initialNarration); // TTS for initial prompt

            // Change background color of the flashcard screen
            const randomGradient = backgroundGradients[Math.floor(Math.random() * backgroundGradients.length)];
            flashcardScreen.className = `flex-1 flex flex-col ${randomGradient} transition-colors duration-500`;
        };

        // Function to render answer options
        const renderOptions = (options) => {
            optionsContainer.innerHTML = ''; // Clear previous options
            options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                // Changed option card color to a different blue for distinction
                button.className = 'p-4 bg-blue-600 rounded-xl shadow-md flex items-center justify-center transition-all duration-300 btn-blue-option text-4xl font-bold text-white transform hover:scale-105';
                button.onclick = () => handleAnswer(option);
                optionsContainer.appendChild(button);
            });
        };

        // Function to spawn stars for appreciation (flying stars)
        const spawnStars = (count, type) => {
            const flashcardRect = flashcardContainer.getBoundingClientRect();
            const startX = flashcardRect.left + flashcardRect.width / 2;
            const startY = flashcardRect.top + flashcardRect.height / 2;

            if (type === 'correct') {
                for (let i = 0; i < count; i++) {
                    const star = document.createElement('i');
                    star.className = 'fas fa-star animated-star-correct';

                    // Position stars to fly out horizontally from the center of the flashcard
                    // Adjust angle to spread stars more horizontally from the center
                    const totalWidth = flashcardRect.width * 0.8; // Spread within 80% of card width
                    const spacing = totalWidth / (count > 1 ? count - 1 : 1);
                    const initialXOffset = -totalWidth / 2 + (i * spacing);

                    star.style.left = `${startX + initialXOffset}px`;
                    star.style.top = `${startY}px`; // Start at the vertical center of the card
                    star.style.setProperty('--star-dx', `${initialXOffset * 0.5}px`); // Small horizontal movement
                    star.style.setProperty('--star-dy', `-50px`); // Move up slightly
                    star.style.setProperty('--star-dx-end', `${initialXOffset * 1.5}px`); // Further horizontal movement
                    star.style.setProperty('--star-dy-end', `-150px`); // Move further up
                    star.style.animationDelay = `${i * 0.1}s`; // Stagger animation

                    starAnimationContainer.appendChild(star);

                    star.addEventListener('animationend', () => {
                        star.remove();
                    }, { once: true });
                }
            } else if (type === 'incorrect') {
                // Animate one star disappearing from the score display
                const scoreRect = scoreDisplay.parentElement.getBoundingClientRect(); // Get parent of score (the rounded box)
                const star = document.createElement('i');
                star.className = 'fas fa-star animated-star-incorrect';
                star.style.left = `${scoreRect.left + scoreRect.width / 2}px`;
                star.style.top = `${scoreRect.top + scoreRect.height / 2}px`;
                starAnimationContainer.appendChild(star);
                star.addEventListener('animationend', () => {
                    star.remove();
                }, { once: true });
            }
        };

        // New function to show stars and text in the empty card during pause
        const showPauseAnimation = (starsChange) => {
            pauseAnimationContainer.classList.remove('hidden');
            pauseAnimationContainer.innerHTML = ''; // Clear previous content

            const starIconsWrapper = document.createElement('div');
            starIconsWrapper.className = 'star-icons-wrapper';

            const starCount = Math.abs(starsChange);
            const starClass = starsChange > 0 ? 'positive' : 'negative';

            for (let i = 0; i < starCount; i++) {
                const starIcon = document.createElement('i');
                starIcon.className = `fas fa-star pause-star-icon ${starClass}`;
                starIcon.style.animationDelay = `${i * 0.1}s`; // Stagger animation for each star
                starIconsWrapper.appendChild(starIcon);
            }
            pauseAnimationContainer.appendChild(starIconsWrapper);

            // Add text for star change
            const starChangeTextElement = document.createElement('span');
            starChangeTextElement.textContent = `${starsChange > 0 ? '+' : ''}${starsChange} Bintang!`;
            starChangeTextElement.classList.add('star-change-text-small', starClass);
            starChangeTextElement.style.animationDelay = `${starCount * 0.1}s`; // Delay text animation slightly after stars
            pauseAnimationContainer.appendChild(starChangeTextElement);
        };


        // Function to handle user's answer
        const handleAnswer = (selectedAnswer) => {
            // Disable options temporarily
            Array.from(optionsContainer.children).forEach(btn => btn.disabled = true);
            clearInterval(timerInterval); // Stop the timer
            clearTimeout(questionTimeout); // Clear the timeout when an answer is selected

            const elapsedTime = (Date.now() - startTime) / 1000;
            let starsChange = 0; // Renamed from starsEarned for clarity (can be negative)
            let feedbackMsg = '';
            let narrationMsg = '';

            if (selectedAnswer === currentQuestion.answer) {
                if (elapsedTime < 2) { // Less than 2 seconds
                    starsChange = 5;
                    feedbackMsg = 'Luar biasa! Sangat cepat!';
                    narrationMsg = `Hebat! Kamu mendapatkan ${starsChange} bintang!`;
                } else if (elapsedTime < 3) { // Less than 3 seconds
                    starsChange = 4;
                    feedbackMsg = 'Hebat! Kamu cepat!';
                    narrationMsg = `Keren! Kamu mendapatkan ${starsChange} bintang!`;
                } else if (elapsedTime < 4) { // Less than 4 seconds
                    starsChange = 3;
                    feedbackMsg = 'Bagus sekali!';
                    narrationMsg = `Mantap! Kamu mendapatkan ${starsChange} bintang!`;
                } else if (elapsedTime < 5) { // Less than 5 seconds
                    starsChange = 2;
                    feedbackMsg = 'Baik! Terus berlatih!';
                    narrationMsg = `Lumayan! Kamu mendapatkan ${starsChange} bintang!`;
                } else if (elapsedTime <= 15) { // Up to 15 seconds
                    starsChange = 1;
                    feedbackMsg = 'Jawabanmu BENAR!';
                    narrationMsg = `Bagus! Kamu mendapatkan ${starsChange} bintang!`;
                } else { // More than 15 seconds (this case should ideally be caught by handleTimeout)
                    starsChange = 0;
                    feedbackMsg = 'Jawabanmu BENAR, tapi sangat lambat.';
                    narrationMsg = 'Ayo lebih cepat lagi!';
                }
                score += starsChange;
                feedbackMessage.classList.remove('text-red-300');
                feedbackMessage.classList.add('text-green-300', 'feedback-show');
            } else {
                starsChange = -1; // Deduct 1 star for incorrect answer
                score = Math.max(0, score + starsChange); // Ensure score doesn't go below 0
                feedbackMsg = 'Salah, ayo coba lagi!';
                narrationMsg = 'Sayang, jawabanmu salah. Bintangmu berkurang!';
                feedbackMessage.classList.remove('text-green-300');
                feedbackMessage.classList.add('text-red-300', 'feedback-show');
            }

            scoreDisplay.textContent = score;
            scoreDisplay.classList.add('score-pop');

            // Trigger flying star animations
            if (starsChange > 0) {
                spawnStars(starsChange, 'correct'); // Pass type 'correct'
            } else if (starsChange < 0) {
                spawnStars(1, 'incorrect'); // Spawn 1 star to animate away for incorrect
            }

            // Set feedback and narration messages
            feedbackMessage.textContent = feedbackMsg;
            narrationTextElement.textContent = narrationMsg;
            
            // Clear question content during feedback phase
            questionExpressionSpan.textContent = '';
            answerSpan.textContent = '';
            flashcardContainer.classList.remove('flipped'); // Ensure card is front-facing if it was flipped

            // Show stars and text in the empty card
            showPauseAnimation(starsChange);

            // Reset count for next question readiness check
            nextQuestionReadyCount = 0;

            // Part 1: Visual animations delay (now includes pause animation duration)
            setTimeout(() => {
                nextQuestionReadyCount++;
                checkNextQuestionReadiness();
            }, 2000); // Increased delay for popInFadeOut animation (2 seconds)

            // Part 2: Narration completion
            speakNarration(narationMsg, () => {
                nextQuestionReadyCount++;
                checkNextQuestionReadiness();
            });

            // Remove animation class after it finishes
            scoreDisplay.addEventListener('animationend', () => {
                scoreDisplay.classList.remove('score-pop');
            }, { once: true });
            feedbackMessage.addEventListener('animationend', () => {
                feedbackMessage.classList.remove('feedback-show');
            }, { once: true });


            // Check for target score achievement
            if (score >= targetScore) {
                // Stop game flow
                clearInterval(timerInterval);
                clearTimeout(questionTimeout);
                Array.from(optionsContainer.children).forEach(btn => btn.disabled = true);

                // Show level complete modal after a short delay
                setTimeout(() => {
                    showLevelCompleteModal();
                }, 2500); // Fixed delay for modal to appear
            }
        };

        // Function for Text-to-Speech
        const speakNarration = (text, callback = () => {}) => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); // Stop any ongoing speech
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'id-ID'; // Set language to Indonesian
                
                utterance.onend = () => {
                    callback(); // Call the provided callback when speech ends
                };
                window.speechSynthesis.speak(utterance);
            } else {
                console.warn('SpeechSynthesis API not supported in this browser.');
                callback(); // Call callback immediately if TTS not supported
            }
        };

        // Function to show the modal
        const showLevelCompleteModal = () => {
            levelCompleteModal.classList.remove('hidden');
            modalContent.classList.remove('scale-90', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100', 'modal-show'); // Add modal-show for transition

            modalMessage.textContent = `Kamu berhasil mengumpulkan ${score} bintang!`;
            const nextTarget = targetScore + 25; // Example progression
            modalNextTarget.textContent = `Siap untuk level berikutnya? Target: ${nextTarget} bintang!`;
            
            // Narasi TTS untuk modal level berikutnya
            speakNarration(`Selamat! Kamu berhasil mencapai ${score} bintang! Siap untuk level berikutnya? Target: ${nextTarget} bintang!`);
        };

        // Function to hide the modal
        const hideLevelCompleteModal = () => {
            modalContent.classList.remove('scale-100', 'opacity-100', 'modal-show');
            modalContent.classList.add('scale-90', 'opacity-0');
            // Hide the modal completely after transition
            modalContent.addEventListener('transitionend', () => {
                levelCompleteModal.classList.add('hidden');
            }, { once: true });
        };

        // Event Listeners
        additionBtn.addEventListener('click', () => {
            currentOperation = 'addition';
            level = 1; // Reset level
            targetScore = 50; // Reset target score
            score = 0; // Reset score for new session
            scoreDisplay.textContent = score;
            targetScoreDisplay.textContent = targetScore; // Update target display
            generateQuestion();
            showScreen('flashcard-screen');
        });

        subtractionBtn.addEventListener('click', () => {
            currentOperation = 'subtraction';
            level = 1; // Reset level
            targetScore = 50; // Reset target score
            score = 0; // Reset score for new session
            scoreDisplay.textContent = score;
            targetScoreDisplay.textContent = targetScore; // Update target display
            generateQuestion();
            showScreen('flashcard-screen');
        });

        flashcardContainer.addEventListener('click', () => {
            flashcardContainer.classList.toggle('flipped');
        });

        // Event listener for "Lanjut ke Level Berikutnya"
        nextLevelBtn.addEventListener('click', () => {
            hideLevelCompleteModal();
            level++; // Increment level
            targetScore += 25; // Increase target score
            score = 0; // Reset score for new level
            scoreDisplay.textContent = score;
            targetScoreDisplay.textContent = targetScore; // Update target display
            generateQuestion(); // Start new level
        });

        // Event listener for "Main Lagi"
        playAgainBtn.addEventListener('click', () => {
            hideLevelCompleteModal();
            level = 1; // Reset level
            targetScore = 50; // Reset target score
            score = 0; // Reset score
            scoreDisplay.textContent = score;
            targetScoreDisplay.textContent = targetScore; // Update target display
            generateQuestion(); // Start new game
        });

        // New event listener for "Saya akan istirahat dulu"
        restBtn.addEventListener('click', () => {
            hideLevelCompleteModal();
            showScreen('home-screen'); // Go back to home screen
            // Reset game state when going back to home screen
            level = 1;
            targetScore = 50;
            score = 0;
        });

        // Initial screen display
        window.onload = () => {
            showScreen('home-screen');
            // initializeFirebase(); // Uncomment to initialize Firebase
        };
    </script>
</body>
</html>
